<% content_for :title, t('title') %>
<% breadcrumb :root %>

<div class="mx-auto max-w-7xl px-4">

  <% if notice.present? %>
    <p id="notice" class="mb-5 inline-block rounded-md bg-green-50 px-3 py-2 font-medium text-green-600"><%= notice %></p>
  <% end %>

  <%= render 'search', q: @q, url: facilities_path %>

  <%= render 'layouts/navigation' %>

  <!-- 地図表示 -->
  <% markers = @facilities
        .select { |f| f.latitude.present? && f.longitude.present? }
        .map { |f|
          {
            id:      f.id,
            lat:     f.latitude.to_f,   # decimal 対策
            lng:     f.longitude.to_f,
            title:   f.title,
            address: f.respond_to?(:full_address) ? f.full_address : [f.prefecture&.name, f.city, f.street, f.building].compact.join,
            url:     facility_path(f),
            category: f.category
          }
        } %>

  <turbo-frame id="facilities">
    <%= tag.div id: "index-map",
        class: "mt-6 h-[480px] w-full rounded-md border border-gray-200 ",
        style: "min-height: 480px",
        data: {
          map_mode: "index",
          markers:  markers,
          center_lat: 35.6895,
          center_lng: 139.6917,
          zoom: 8,
          min_zoom: 6,
          zoom_single: 16
        } %>
    </div>

  <!-- 検索結果 / 一覧 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <%= render partial: 'facilities/facility',
                collection: @facilities,
                as: :facility,
                locals: { full_image: false } %>
    </div>

    <div class="mt-16 flex justify-end">
      <%= paginate @facilities, params: request.query_parameters %>
      <%# ↑ categoryパラメータをページングリンクにも引き継ぐ %>
    </div>
  </turbo-frame>
</div>
